# La NekoCafe - 本番環境用 Docker Compose 設定
# このファイルは本番環境でのデプロイメントに使用します

services:
    # Laravel アプリケーション
    laravel:
        build:
            context: .
            dockerfile: Dockerfile.prod
        container_name: lanekocafe_laravel
        restart: unless-stopped
        environment:
            APP_ENV: production
            APP_DEBUG: "false"
            CONTAINER_ROLE: app
        volumes:
            - ./storage:/var/www/html/storage
            - ./bootstrap/cache:/var/www/html/bootstrap/cache
        networks:
            - internal
            - web
        depends_on:
            mysql:
                condition: service_healthy
            redis:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "php", "artisan", "inspire"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Nginx リバースプロキシ
    nginx:
        image: nginx:alpine
        container_name: lanekocafe_nginx
        restart: unless-stopped
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ./docker/nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
            - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
            - ./public:/var/www/html/public:ro
            - ./docker/ssl:/etc/nginx/ssl:ro
        networks:
            - web
        depends_on:
            - laravel
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
            interval: 30s
            timeout: 10s
            retries: 3

    # MySQL データベース
    mysql:
        image: mysql:8.0
        container_name: lanekocafe_mysql
        restart: unless-stopped
        ports:
            - "${FORWARD_DB_PORT:-3306}:3306"
        environment:
            MYSQL_ROOT_PASSWORD: "${DB_PASSWORD}"
            MYSQL_DATABASE: "${DB_DATABASE}"
            MYSQL_USER: "${DB_USERNAME}"
            MYSQL_PASSWORD: "${DB_PASSWORD}"
            MYSQL_ALLOW_EMPTY_PASSWORD: "no"
        volumes:
            - mysql-data:/var/lib/mysql
            - ./docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro
        networks:
            - internal
        command: >
            --default-authentication-plugin=mysql_native_password
            --character-set-server=utf8mb4
            --collation-server=utf8mb4_unicode_ci
            --max-connections=200
            --innodb-buffer-pool-size=2G
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_PASSWORD}"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    # Redis（セッション・キャッシュ）
    redis:
        image: redis:7-alpine
        container_name: lanekocafe_redis
        restart: unless-stopped
        ports:
            - "${FORWARD_REDIS_PORT:-6379}:6379"
        command: redis-server --requirepass "${REDIS_PASSWORD}" --maxmemory 512mb --maxmemory-policy allkeys-lru
        volumes:
            - redis-data:/data
        networks:
            - internal
        healthcheck:
            test: ["CMD-SHELL", "echo 'auth ${REDIS_PASSWORD}\nping' | redis-cli | grep PONG"]
            interval: 10s
            timeout: 5s
            retries: 5

    # Keycloak（本番モード）
    keycloak:
        image: quay.io/keycloak/keycloak:26.0
        container_name: lanekocafe_keycloak
        restart: unless-stopped
        command: start --optimized
        ports:
            - "${KEYCLOAK_PORT:-8443}:8443"
            - "9000:9000" # メトリクスポート
        environment:
            # 管理者アカウント
            KEYCLOAK_ADMIN: "${KEYCLOAK_ADMIN_USERNAME}"
            KEYCLOAK_ADMIN_PASSWORD: "${KEYCLOAK_ADMIN_PASSWORD}"

            # データベース設定（PostgreSQL）
            KC_DB: postgres
            KC_DB_URL: "jdbc:postgresql://keycloak-postgres:5432/${KEYCLOAK_DB_NAME}"
            KC_DB_USERNAME: "${KEYCLOAK_DB_USERNAME}"
            KC_DB_PASSWORD: "${KEYCLOAK_DB_PASSWORD}"
            KC_DB_POOL_INITIAL_SIZE: 50
            KC_DB_POOL_MAX_SIZE: 200
            KC_DB_POOL_MIN_SIZE: 10

            # HTTPS/TLS設定
            KC_HTTPS_CERTIFICATE_FILE: /opt/keycloak/conf/tls.crt
            KC_HTTPS_CERTIFICATE_KEY_FILE: /opt/keycloak/conf/tls.key

            # ホスト名設定
            KC_HOSTNAME: "${KEYCLOAK_HOSTNAME}"
            KC_HOSTNAME_STRICT: "true"
            KC_HOSTNAME_STRICT_HTTPS: "true"
            KC_HTTP_ENABLED: "false"

            # プロキシ設定
            KC_PROXY: edge
            KC_PROXY_HEADERS: xforwarded

            # ヘルスチェックとメトリクス
            KC_HEALTH_ENABLED: "true"
            KC_METRICS_ENABLED: "true"

            # ログ設定
            KC_LOG_LEVEL: INFO
            KC_LOG: console,file
            KC_LOG_FILE: /opt/keycloak/data/log/keycloak.log

            # キャッシュ設定
            KC_CACHE: ispn
            KC_CACHE_STACK: tcp

            # JVMオプション
            JAVA_OPTS: >-
                -Xms2g
                -Xmx4g
                -XX:MetaspaceSize=256m
                -XX:MaxMetaspaceSize=512m
                -XX:+UseG1GC
                -XX:MaxGCPauseMillis=200
                -XX:ParallelGCThreads=4
                -XX:ConcGCThreads=2
                -XX:InitiatingHeapOccupancyPercent=45
        volumes:
            - ./docker/keycloak/tls/tls.crt:/opt/keycloak/conf/tls.crt:ro
            - ./docker/keycloak/tls/tls.key:/opt/keycloak/conf/tls.key:ro
            - keycloak-data:/opt/keycloak/data
        networks:
            - internal
            - web
        depends_on:
            keycloak-postgres:
                condition: service_healthy
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    'exec 3<>/dev/tcp/127.0.0.1/8443; echo -e "GET /health/ready HTTP/1.1\r\nhost: 127.0.0.1:8443\r\nConnection: close\r\n\r\n" >&3; grep "HTTP/1.1 200 OK" <&3',
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 90s

    # Keycloak用 PostgreSQL
    keycloak-postgres:
        image: postgres:16-alpine
        container_name: lanekocafe_keycloak_postgres
        restart: unless-stopped
        environment:
            POSTGRES_DB: "${KEYCLOAK_DB_NAME}"
            POSTGRES_USER: "${KEYCLOAK_DB_USERNAME}"
            POSTGRES_PASSWORD: "${KEYCLOAK_DB_PASSWORD}"
        volumes:
            - keycloak-postgres-data:/var/lib/postgresql/data
            - ./docker/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
        networks:
            - internal
        command: postgres -c config_file=/etc/postgresql/postgresql.conf
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${KEYCLOAK_DB_USERNAME}"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    # Prometheus（メトリクス収集）
    prometheus:
        image: prom/prometheus:latest
        container_name: lanekocafe_prometheus
        restart: unless-stopped
        ports:
            - "9090:9090"
        volumes:
            - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - prometheus-data:/prometheus
        networks:
            - internal
        command:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
            - "--storage.tsdb.retention.time=30d"
            - "--web.console.libraries=/usr/share/prometheus/console_libraries"
            - "--web.console.templates=/usr/share/prometheus/consoles"
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
            interval: 30s
            timeout: 10s
            retries: 3

    # Grafana（メトリクス可視化）
    grafana:
        image: grafana/grafana:latest
        container_name: lanekocafe_grafana
        restart: unless-stopped
        ports:
            - "3000:3000"
        environment:
            GF_SECURITY_ADMIN_USER: "${GRAFANA_ADMIN_USER:-admin}"
            GF_SECURITY_ADMIN_PASSWORD: "${GRAFANA_ADMIN_PASSWORD}"
            GF_INSTALL_PLUGINS: ""
        volumes:
            - grafana-data:/var/lib/grafana
            - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
        networks:
            - internal
        depends_on:
            - prometheus
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
            interval: 30s
            timeout: 10s
            retries: 3

volumes:
    mysql-data:
        driver: local
    redis-data:
        driver: local
    keycloak-data:
        driver: local
    keycloak-postgres-data:
        driver: local
    prometheus-data:
        driver: local
    grafana-data:
        driver: local

networks:
    # 内部ネットワーク（データベース、キャッシュ等）
    internal:
        driver: bridge
        internal: true
    # 外部公開ネットワーク（Nginx、Keycloak等）
    web:
        driver: bridge

